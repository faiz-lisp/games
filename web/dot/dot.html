<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dot!</title>
  <style>
    #rows,#cols {
      width: 50px;
    }
    
    #board {
      cursor: pointer;
    }
    
    #colorDisplay {
      width: 20px;
      height: 20px;
      border: 1px solid black;
    }
    
    #page {
      width: 500px;
      height: 600px;
      margin: 0 auto;
    }
    
    #procedure {
      width: 800px;
      height: 200px;
    }
  </style>
</head>
<body>
  <div id="page">
    <div id="board"></div>
    <span id="position">行: 列: </span>
    <!--
    行: <input id="rows" type="text" value="" maxlength="3" />
    列: <input id="cols" type="text" value="" maxlength="3" />
    -->
    <div id="colorPicker">
    当前画笔色: <select>
         <option value="rgba" selected="selected">#RGBA</option>
         <option value="rgbacvs">R,G,B,A</option>
         <!-- <option value="name">名称</option> -->
       </select>
     <input id="txtColor" type="text" maxlength="11" />
     <div id="colorDisplay"></div>
    </div>
    <label for="eraserMode">选择橡皮擦:</label><input id="eraserMode" type="checkbox" />
    <label for="toggleGridEnable">显示网格:</label><input id="toggleGridEnable" type="checkbox" checked="checked"/>
  </div>
  <div id="procedure">
    画板数据
    ->
    <!--
    选择器:
    <select id="selSelector">
      <option value="tableArray">表格数组</option>
      <option value="identity">identity</option>
      <option value="custom">自定义</option>
    </select>
    -->
    转换器:
    <select id="selTransformer">
      <option value="default">默认</option>
      <option value="columns">列</option>

      <!-- <option value="identity">identity</option> -->
      <option value="custom">自定义</option>
    </select>
    <!--
    ->
    映射函数:
    <select id="selMapper">
      <option value="linecvs" selected="selected">行逗号分割</option>
      <option value="linecvss">行空格分割</option>
      <option value="custom">自定义</option>
    </select>
    -->
    <button id="save">保存</button>
    <button id="open">打开</button>
  </div>
<script src="../libs/jquery/jquery.min.js"></script>
<script src="../libs/signals.min.js"></script>

<script>
var Signal = signals.Signal;

function Board(params) {
  var board = this;
  
  var colorPicker = params.colorPicker;
  var rows = params.rows;
  var cols = params.cols;
  var width = 500;
  var height = 500;
  var gridEnabled = true;
  var DEFAULT_OUTLINE = '1px solid #dbdbdb';
  
  var divBoard = $("#board");
  divBoard.css({
    width: width + 'px',
    height: height + 'px',
    margin: '0 auto'
  });
  
  this.table = createTable();
  
  divBoard.append(this.table);
  
  this.signals = {
    cellOvered: new Signal(),
    cellClicked: new Signal()
  };
  
  this.enableGrid = function(enable) {
    gridEnabled = enable;
    var outline = gridEnabled ? DEFAULT_OUTLINE: '';
    for (var r = 0; r < rows; r++)
      for (var c = 0; c < cols; c++)
        $(this.table.rows[r].cells[c]).css('outline', outline);
  }
  
  this.loadArray = function(array) {
    for (var r = 0; r < array.length; r++) {
      for (var c = 0, len = array[r].length; c < len; c++) {
        var rgbahex = '#' + array[r][c].color.map(function(n, i){
          var v = (+n).toString(16);
          return v == '0' && i == 3 ? '00' : v;
        }).join('');
        $(this.table.rows[r].cells[c]).css('background-color', rgbahex);
      }
    }
  }
  
  function createTable() {
    var table = $(document.createElement('table'));
    table.attr('cellpadding', 0);
    table.attr('cellspacing', 0);
    table.css({
      width: width + 'px',
      height: height + 'px',
      border: '2px solid black'
    });
    
    var cellW = (width - (cols-1)*2) / cols;
    var cellH = (height - (rows-1)*2) / rows;
    var tr, td;
    for (var r = 0; r < rows; r++) {
      tr = $(document.createElement('tr'));
      for (var c = 0; c < cols; c++) {
        td = document.createElement('td');
        td.index = [r, c];
        td.id = r + '-' + c;
        
        td.onmouseover = function() {
          $(this).css({
            outline: '1px solid red',
          });
          board.signals.cellOvered.dispatch(this);
        };
        td.onmouseout = function() {
          $(this).css({
            outline: gridEnabled ? DEFAULT_OUTLINE: '',
          });
          board.signals.cellOvered.dispatch(this);
        };
        
        td.onclick = function() {
          board.signals.cellClicked.dispatch(this);
        };
        
        td = $(td);
        td.css({
          width: cellW + 'px',
          height: cellH + 'px',
          backgroundColor: '#FFFFFF',
          padding: 0,
          outline: gridEnabled ? DEFAULT_OUTLINE: '',
        });
        tr.append(td);
      }
      table.append(tr);
    }
    
    return table.get(0);
  }
  
}

function BoardDataProcedure(board) {
  var procedure = this;
  var selectors = {};
  
  // select table
  selectors['identity'] = identity;
  selectors['tableArray'] = function(board) {
    var array = [], cell;
    for (var r = 0, rows = board.table.rows; r < rows.length; r++) {
      array.push([]);
      for (var c = 0, len = rows[r].cells.length; c < len; c++) {
        cell = rows[r].cells[c];
        array[r].push( {index: [r, c], color: $(cell).css('background-color')} );
      }
    }
    return array;
  };
  
  var transformers = [];
  // identity
  transformers['identity'] = identity;
  transformers['columns'] = function(rows) {
    return rows.map(function(cells) {
      return cells.map(function(c) {
        return getRgbaValueAsArray(c.color).join(',');
      }).join('\n');
    }).join('\n');
  };
  transformers['default'] = function(rows) {
    return rows.map(function(cells) {
      return cells.map(function(c) {
        return getRgbaValueAsArray(c.color).join('|');
      }).join(',');
    }).join('\n');
  };
  
  var mappers = [];
  mappers['linecvs'] = function(data) {
    return mapJoin(data, ',');
  };
  mappers['linecvss'] = function(data) {
    return mapJoin(data, ' ');
  };
  
  procedure.selectors = selectors;
  procedure.transformers = transformers;
  procedure.mappers = mappers;
  
  this.exec = function() {
    var selectorName = 'tableArray';//$('#selSelector').val();
    var transformerName = $('#selTransformer').val();
    //var mapperName = $('#selMapper').val();
    
    if (selectorName == 'custom') {
      selectorName = prompt('名称:');
    }
    if (transformerName == 'custom') {
      transformerName = prompt('名称:');
    }
    /*
    if (mapperName == 'custom') {
      mapperName = prompt('名称:');
    }*/
    
    return transformers[transformerName](
        selectors[selectorName](board));
  }
  
  function identity(x) {
    return x;
  }
  
  function mapJoin(data, separator) {
    return data.map(function(v) {
      return JSON.stringify(v);
    }).join('\n');
  }
  
  function getRgbaValueAsArray(strVal) {
    var srgba = strVal.substring(
      strVal.substring(0, 4) == 'rgba' ? 5 : 4,
      strVal.length - 1);
    var rgba = srgba.split(', ');
    if (rgba.length == 4 && rgba[3] == '0')
      rgba = rgba.slice(0, 3);
    return rgba;
  }
}

function ColorPicker() {
  var value = '';
  
  this.setValue = function(_value) {
    value = _value;
    $('#txtColor').val(value);
    $('#txtColor').change();
  }
  this.getValue = function() {
    return value;
  }
  
  $('#txtColor').change(function() {
    value = this.value;
    $('#colorDisplay').css('background-color', value);
  });
}

function loadFile(files) {
  if(!files.length)
    return;
  var file = files[0];
  var reader = new FileReader();
  reader.onload = function() {
    var lines = this.result;
    
    lines = lines.split('\n');
    var array = lines.map(function(line){
      var cells = line.split(',');
      return cells.map(function(cell){
        var cellObj = {};
        var rgba = cell.split('|');
        for (var i = rgba.length; i < 4; i++)
          rgba[i] = 0;
        cellObj.color = rgba;
        return cellObj;
      });
    });
    board.loadArray(array);
  };
  reader.readAsText(file);
}
$(function() {
  window.colorPicker = new ColorPicker();
  colorPicker.setValue('#FF0000');
  
  window.board = new Board({
    rows: 24,
    cols: 24,
    colorPicker: colorPicker
  });
  
  var eraserMode = false;
  
  board.signals.cellOvered.add(function(cell) {
    $('#position').text('行:' + cell.index[0] + ' ' + '列:' + cell.index[1]);
  });
  board.signals.cellClicked.add(function(cell) {
    $(cell).css('background-color', eraserMode ? '' : colorPicker.getValue());
  });
  
  $('#eraserMode').change(function() {
    eraserMode = this.checked;
  });
  $('#toggleGridEnable').change(function() {
    board.enableGrid(this.checked);
  });
  
  window.boardDataProcedure = new BoardDataProcedure(board);

  $('#save').click(function(){ 
    var output = boardDataProcedure.exec();

    var blob = new Blob( [ output ], { type: 'text/plain;charset=utf8' } );
    var objectURL = URL.createObjectURL( blob );

    window.open( objectURL, '_blank' );
    window.focus();
  });
  
  $('#open').click(function(){ 
    var fileUpload = document.getElementById('file');
    if(fileUpload == null) {
        fileUpload = document.createElement('input');
        fileUpload.id = 'file';
        fileUpload.type = 'file';
        fileUpload.addEventListener('change', function() {
            loadFile(this.files);
        });
        document.body.appendChild(fileUpload);
    }

    fileUpload.click();
  });
});
</script>
</html>
</body>
